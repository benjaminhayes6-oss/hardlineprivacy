
import { getStore } from '@netlify/blobs';
import { verifyJWT } from './_lib/jwt.js';
function json(status, body){ return { statusCode: status, headers:{'Content-Type':'application/json; charset=utf-8'}, body: JSON.stringify(body) }; }
function isAdminEmail(email){ return (process.env.HP_ADMIN_EMAILS||'').split(',').map(s=>s.trim().toLowerCase()).includes((email||'').toLowerCase()); }
async function requireAdmin(event){ const cookies = event.headers.cookie || ''; const token = (cookies.match(/hp_session=([^;]+)/)||[])[1] || ''; const payload = verifyJWT(token, process.env.JWT_SECRET); if (!isAdminEmail(payload.email)) throw new Error('not admin'); return payload.email.toLowerCase(); }
export async function handler(event){ try{ await requireAdmin(event); const store = getStore('entitlements'); const action = (event.queryStringParameters||{}).action || 'list'; if (action === 'list'){ const out = []; for await (const key of store.list()){ const val = await store.get(key); out.push(JSON.parse(val)); } return json(200, out); } const body = JSON.parse(event.body||'{}'); const email = (body.email||'').toLowerCase(); if (!email) return json(400, { error:'Missing email' }); if (action === 'grant'){ const rec = { email, entitled:true, plan: body.plan||'admin-grant', updatedAt:new Date().toISOString() }; await store.set(email, JSON.stringify(rec)); return json(200, { ok:true, rec }); } if (action === 'revoke'){ const rec = { email, entitled:false, plan:null, updatedAt:new Date().toISOString() }; await store.set(email, JSON.stringify(rec)); return json(200, { ok:true, rec }); } return json(400, { error:'Unknown action' }); }catch(e){ return json(403, { error:'Forbidden' }); } }
