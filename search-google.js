export async function handler(event){ try{ const { GOOGLE_API_KEY, GOOGLE_CX, ALLOWED_ORIGINS }=process.env; if(!GOOGLE_API_KEY||!GOOGLE_CX) return json(500,{error:'Google keys not configured'}); const p=new URLSearchParams(event.queryStringParameters||{}); const q=(p.get('q')||'').trim(); const start=p.get('start')||'1'; if(!q) return json(400,{error:'Missing q'}); const u=new URL('https://www.googleapis.com/customsearch/v1'); u.searchParams.set('key',GOOGLE_API_KEY); u.searchParams.set('cx',GOOGLE_CX); u.searchParams.set('q',q); u.searchParams.set('start',start); const r=await fetch(u.toString()); const d=await r.json(); const items=(d.items||[]).map(it=>({title:it.title,url:it.link,snippet:it.snippet,source:'google'})); return json(200,{q,engine:'google',items},{origins:ALLOWED_ORIGINS,ttl:60}); }catch(e){ return json(500,{error:'Google search error',details:e.message}); } } function json(s,b,o={}){ const h=base(o.origins,o.ttl); return { statusCode:s, headers:h, body: JSON.stringify(b)} } function base(origins,ttl){ const allow=(origins||'').split(',').map(s=>s.trim()).filter(Boolean); const h={'Content-Type':'application/json; charset=utf-8','Cache-Control':`public, max-age=${ttl||0}`}; if(allow.length){ h['Access-Control-Allow-Origin']=allow[0]; h['Vary']='Origin'; } return h }
