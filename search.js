
export async function handler(event){ try{ const { ALLOWED_ORIGINS } = process.env; const params = new URLSearchParams(event.queryStringParameters||{}); const q=(params.get('q')||'').trim(); const engine=(params.get('engine')||'both').toLowerCase(); if(!q) return json(400,{error:'Missing q'}); const tasks=[]; if(engine==='google'||engine==='both') tasks.push(google(q)); if(engine==='bing'||engine==='both') tasks.push(bing(q)); const results=await Promise.all(tasks); let items=results.flat(); const seen=new Set(); items=items.filter(r=>{ const key=(r.url||'').replace(/\/$/,''); if(seen.has(key)) return false; seen.add(key); return true;}); if(engine==='both'){ const g=items.filter(i=>i.source==='google'); const b=items.filter(i=>i.source==='bing'); items=interleave(g,b);} return json(200,{q,engine,items},{origins:ALLOWED_ORIGINS,ttl:60}); }catch(e){ return json(500,{error:'Search error',details:e.message}); }} async function google(q){ const { GOOGLE_API_KEY, GOOGLE_CX }=process.env; if(!GOOGLE_API_KEY||!GOOGLE_CX) return []; const u=new URL('https://www.googleapis.com/customsearch/v1'); u.searchParams.set('key',GOOGLE_API_KEY); u.searchParams.set('cx',GOOGLE_CX); u.searchParams.set('q',q); const r=await fetch(u.toString()); const d=await r.json(); return (d.items||[]).map(it=>({title:it.title,url:it.link,snippet:it.snippet,source:'google'})); } async function bing(q){ const { BING_V7_KEY }=process.env; if(!BING_V7_KEY) return []; const u=new URL('https://api.bing.microsoft.com/v7.0/search'); u.searchParams.set('q',q); u.searchParams.set('count','10'); u.searchParams.set('safeSearch','Moderate'); const r=await fetch(u.toString(),{headers:{'Ocp-Apim-Subscription-Key':BING_V7_KEY}}); const d=await r.json(); const v=(d.webPages&&d.webPages.value)||[]; return v.map(it=>({title:it.name,url:it.url,snippet:it.snippet,source:'bing'})); } function interleave(a,b){ const out=[]; const m=Math.max(a.length,b.length); for(let i=0;i<m;i++){ if(a[i]) out.push(a[i]); if(b[i]) out.push(b[i]); } return out;} function json(status, body, opts={}){ const headers=baseHeaders(opts.origins, opts.ttl); return { statusCode: status, headers, body: JSON.stringify(body) } } function baseHeaders(origins, ttl){ const allow=(origins||'').split(',').map(s=>s.trim()).filter(Boolean); const h={'Content-Type':'application/json; charset=utf-8','Cache-Control':`public, max-age=${ttl||0}`}; if(allow.length){ h['Access-Control-Allow-Origin']=allow[0]; h['Vary']='Origin'; } return h; }
