name: Hardline Advanced SEO Signal Engine

on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  signals:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install google-api-python-client google-auth

      - name: Create GSC credential file
        run: echo '${{ secrets.GSC_SERVICE_ACCOUNT_JSON }}' > gsc-key.json

      - name: Pull Comparison Data
        run: |
          python3 <<EOF
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from datetime import date, timedelta

          SCOPES = ['https://www.googleapis.com/auth/webmasters.readonly']
          credentials = service_account.Credentials.from_service_account_file(
              'gsc-key.json', scopes=SCOPES)

          service = build('searchconsole', 'v1', credentials=credentials)

          today = date.today()

          def query_data(start, end):
              request = {
                  'startDate': str(start),
                  'endDate': str(end),
                  'dimensions': ['query'],
                  'rowLimit': 1500
              }
              return service.searchanalytics().query(
                  siteUrl='https://www.hardlineprivacy.com/',
                  body=request).execute()

          current = query_data(today - timedelta(days=7), today)
          previous = query_data(today - timedelta(days=14), today - timedelta(days=7))

          with open('current.json', 'w') as f:
              json.dump(current, f)

          with open('previous.json', 'w') as f:
              json.dump(previous, f)
          EOF

      - name: Analyze Signals
        id: analyze
        run: |
          python3 <<EOF
          import json

          with open('current.json') as f:
              current = json.load(f)

          with open('previous.json') as f:
              previous = json.load(f)

          alerts = []

          prev_map = {row['keys'][0]: row for row in previous.get('rows', [])}

          for row in current.get('rows', []):
              query = row['keys'][0]
              impressions = row['impressions']
              clicks = row['clicks']
              ctr = row['ctr']
              position = row['position']

              if query in prev_map:
                  prev = prev_map[query]
                  prev_impressions = prev['impressions']
                  prev_ctr = prev['ctr']
                  prev_position = prev['position']

                  if prev_impressions > 0:
                      change = (impressions - prev_impressions) / prev_impressions

                      if change > 0.4:
                          alerts.append(f"Impression Spike: {query}")

                      if change < -0.3:
                          alerts.append(f"Impression Drop: {query}")

                  if prev_ctr > 0 and (ctr - prev_ctr) / prev_ctr < -0.3:
                      alerts.append(f"CTR Crash: {query}")

                  if position - prev_position > 5:
                      alerts.append(f"Ranking Drop: {query}")

              else:
                  if impressions > 100:
                      alerts.append(f"New High-Impression Query: {query}")

          with open('alerts.txt', 'w') as f:
              for alert in alerts:
                  f.write(alert + "\n")

          if alerts:
              print("trigger=true")
          else:
              print("trigger=false")
          EOF

          TRIGGER=$(cat alerts.txt | wc -l)
          if [ "$TRIGGER" -gt 0 ]; then
            echo "trigger=true" >> $GITHUB_OUTPUT
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Alert Email
        if: steps.analyze.outputs.trigger == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Hardline SEO Signal Alert"
          to: ${{ secrets.EMAIL_USERNAME }}
          from: Hardline War Room
          body: |
            Advanced SEO Signal Triggered.

            See GitHub Actions for full breakdown.

      - name: Upload Signal Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seo-signal-report
          path: |
            current.json
            previous.json
            alerts.txt
