name: Hardline Privacy AI Growth Engine

on:
  schedule:
    - cron: '0 15 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1800

jobs:
  ai-growth:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # -------------------------------------
      # Detect Missing Broker Pages
      # -------------------------------------
      - name: Detect Missing Pages
        id: brokers
        run: |
          BROKERS=("radaris" "beenverified" "truthfinder" "intelius" "peekyou")
          MISSING=""
          for broker in "${BROKERS[@]}"; do
            if [ ! -f "./${broker}-removal.html" ]; then
              MISSING="$MISSING $broker"
            fi
          done
          echo "missing=$MISSING" >> $GITHUB_OUTPUT

      # -------------------------------------
      # Generate AI Content
      # -------------------------------------
      - name: Generate Broker Pages via OpenAI
        if: steps.brokers.outputs.missing != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for broker in ${{ steps.brokers.outputs.missing }}; do

            PROMPT="Write a 1500+ word authoritative data broker removal guide for ${broker}. 
            Include:
            - Clear step-by-step removal instructions
            - Warnings about identity verification
            - Timeline expectations
            - Common issues
            - FAQ section
            - Professional, high-authority tone
            - SEO optimized headings (H2, H3)
            - Structured FAQ JSON-LD schema at bottom."

            RESPONSE=$(curl -s https://api.openai.com/v1/responses \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"${MODEL}\",
                \"max_output_tokens\": ${MAX_TOKENS},
                \"input\": [
                  {
                    \"role\": \"user\",
                    \"content\": \"$PROMPT\"
                  }
                ]
              }")

            CONTENT=$(echo $RESPONSE | jq -r '.output_text')

            FILE="${broker}-removal.html"

            echo "<!DOCTYPE html>" > $FILE
            echo "<html><head>" >> $FILE
            echo "<title>${broker^} Removal Guide | Hardline Privacy</title>" >> $FILE
            echo "<meta name=\"description\" content=\"How to remove yourself from ${broker}. Step-by-step privacy opt-out guide.\">" >> $FILE
            echo "</head><body>" >> $FILE
            echo "<h1>How to Remove Yourself from ${broker^}</h1>" >> $FILE
            echo "$CONTENT" >> $FILE
            echo "<hr>" >> $FILE
            echo "<p><strong>Need professional removal help?</strong> <a href=\"/pricing\">Start your removal here</a>.</p>" >> $FILE
            echo "</body></html>" >> $FILE

          done

      # -------------------------------------
      # Create Branch + PR
      # -------------------------------------
      - name: Create Branch and Commit
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="ai-growth-$(date +%s)"
            git checkout -b $BRANCH
            git config --global user.name "Hardline AI Growth"
            git config --global user.email "growth@hardlineprivacy.com"
            git add .
            git commit -m "AI-generated broker page expansion"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          fi

      - name: Open Pull Request
        if: env.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "AI Broker Page Expansion",
              head: process.env.branch,
              base: "main",
              body: "Automated AI-generated broker removal guides for authority expansion."
            })
