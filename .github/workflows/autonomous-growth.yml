name: Hardline Autonomous Growth Engine

on:
  schedule:
    - cron: '0 15 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1800
  MAX_BROKER_PAGES: 5
  MAX_BLOG_POSTS: 2

jobs:
  ai-growth:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # -------------------------------
      # DEFINE BROKER TARGET LIST
      # -------------------------------
      - name: Select Broker Targets
        id: brokers
        run: |
          BROKERS=("radaris" "beenverified" "truthfinder" "intelius" "peekyou" "peoplefinder" "whitepages" "spokeo" "fastpeoplesearch" "mylife")
          COUNT=0
          SELECTED=""
          for broker in "${BROKERS[@]}"; do
            if [ ! -f "./${broker}-removal.html" ] && [ $COUNT -lt $MAX_BROKER_PAGES ]; then
              SELECTED="$SELECTED $broker"
              COUNT=$((COUNT+1))
            fi
          done
          echo "selected=$SELECTED" >> $GITHUB_OUTPUT

      # -------------------------------
      # GENERATE BROKER PAGES
      # -------------------------------
      - name: Generate Broker Pages
        if: steps.brokers.outputs.selected != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for broker in ${{ steps.brokers.outputs.selected }}; do

            PROMPT="Write a 1500+ word authoritative, SEO-optimized removal guide for ${broker}.
            Include:
            - Step-by-step removal process
            - Warnings
            - Timeline expectations
            - FAQ section
            - JSON-LD FAQ schema at bottom
            - Professional legal tone"

            RESPONSE=$(curl -s https://api.openai.com/v1/responses \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"${MODEL}\",
                \"max_output_tokens\": ${MAX_TOKENS},
                \"input\": \"$PROMPT\"
              }")

            CONTENT=$(echo $RESPONSE | jq -r '.output_text')

            FILE="${broker}-removal.html"

            echo "<!DOCTYPE html><html><head>" > $FILE
            echo "<title>${broker^} Removal Guide | Hardline Privacy</title>" >> $FILE
            echo "<meta name=\"description\" content=\"How to remove yourself from ${broker}. Step-by-step opt-out guide.\">" >> $FILE
            echo "</head><body>" >> $FILE
            echo "<h1>How to Remove Yourself from ${broker^}</h1>" >> $FILE
            echo "$CONTENT" >> $FILE
            echo "<p><strong>Need help?</strong> <a href=\"/pricing\">Start here</a>.</p>" >> $FILE
            echo "</body></html>" >> $FILE

          done

      # -------------------------------
      # GENERATE BLOG POSTS
      # -------------------------------
      - name: Generate Blog Posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p blog
          TOPICS=("How data brokers get your information" "Best alternatives to DeleteMe" "Is TruthFinder legal" "How to remove your phone number from data broker sites")
          COUNT=0
          for topic in "${TOPICS[@]}"; do
            if [ $COUNT -ge $MAX_BLOG_POSTS ]; then break; fi

            SLUG=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' )

            if [ ! -f "./blog/$SLUG.html" ]; then

              RESPONSE=$(curl -s https://api.openai.com/v1/responses \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "{
                  \"model\": \"${MODEL}\",
                  \"max_output_tokens\": ${MAX_TOKENS},
                  \"input\": \"Write a 1200+ word SEO authority article on: $topic. Include internal linking suggestions and FAQs.\"
                }")

              CONTENT=$(echo $RESPONSE | jq -r '.output_text')

              FILE="blog/$SLUG.html"
              echo "<!DOCTYPE html><html><head><title>$topic | Hardline Privacy</title></head><body>" > $FILE
              echo "<h1>$topic</h1>" >> $FILE
              echo "$CONTENT" >> $FILE
              echo "</body></html>" >> $FILE

              COUNT=$((COUNT+1))
            fi
          done

      # -------------------------------
      # UPDATE SITEMAP
      # -------------------------------
      - name: Update Sitemap
        run: |
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml
          for file in *.html blog/*.html; do
            echo "<url><loc>https://www.hardlineprivacy.com/$file</loc></url>" >> sitemap.xml
          done
          echo "</urlset>" >> sitemap.xml

      # -------------------------------
      # CREATE SINGLE GROWTH PR
      # -------------------------------
      - name: Commit and Create PR
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="ai-growth-$(date +%s)"
            git checkout -b $BRANCH
            git config --global user.name "Hardline AI Engine"
            git config --global user.email "growth@hardlineprivacy.com"
            git add .
            git commit -m "Autonomous AI growth expansion"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          fi

      - name: Open Pull Request
        if: env.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "AI Growth Expansion Batch",
              head: process.env.branch,
              base: "main",
              body: "Automated expansion: broker pages + blog content + sitemap update."
            })
