name: Hardline Strategic Intelligence Engine

on:
  schedule:
    - cron: '0 18 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1500
  MAX_INFO_POSTS: 2
  REFRESH_DAYS: 90

jobs:
  intelligence:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ----------------------------------
      # PAGE QUALITY SCORING
      # ----------------------------------
      - name: Score Broker Pages
        id: scoring
        run: |
          WEAK=""
          for file in *-removal.html; do
            if [ -f "$file" ]; then
              WORDS=$(wc -w < "$file")
              grep -q "application/ld+json" "$file" || MISSING_SCHEMA=1
              grep -q "/pricing" "$file" || MISSING_CTA=1

              SCORE=0
              [ "$WORDS" -gt 1200 ] && SCORE=$((SCORE+1))
              [ -z "$MISSING_SCHEMA" ] && SCORE=$((SCORE+1))
              [ -z "$MISSING_CTA" ] && SCORE=$((SCORE+1))

              LAST_MOD=$(git log -1 --format="%ct" -- "$file")
              NOW=$(date +%s)
              AGE=$(( (NOW - LAST_MOD) / 86400 ))

              if [ "$SCORE" -lt 3 ] || [ "$AGE" -gt "$REFRESH_DAYS" ]; then
                WEAK="$WEAK $file"
              fi
            fi
          done

          echo "weak=$WEAK" >> $GITHUB_OUTPUT

      # ----------------------------------
      # AI KEYWORD CLUSTER EXPANSION
      # ----------------------------------
      - name: Discover Keyword Gaps
        id: keywords
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          SEED="data broker removal, opt out guide, privacy protection services"
          RESPONSE=$(curl -s https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"${MODEL}\",
              \"max_output_tokens\": 800,
              \"input\": \"Expand these into high-intent SEO keyword clusters with clear informational or commercial intent classification: $SEED\"
            }")

          echo "$RESPONSE" > keyword-discovery.json

      # ----------------------------------
      # GENERATE HIGH-INTENT INFO POSTS
      # ----------------------------------
      - name: Generate Informational Posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p blog
          TOPICS=("how to stop data brokers from selling your information" "why does my name appear on people search sites")
          COUNT=0

          for topic in "${TOPICS[@]}"; do
            if [ $COUNT -ge $MAX_INFO_POSTS ]; then break; fi
            SLUG=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            FILE="blog/$SLUG.html"

            if [ ! -f "$FILE" ]; then
              RESPONSE=$(curl -s https://api.openai.com/v1/responses \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "{
                  \"model\": \"${MODEL}\",
                  \"max_output_tokens\": ${MAX_TOKENS},
                  \"input\": \"Write a high-authority SEO article on: $topic. Include FAQ schema and internal links to removal guides.\"
                }")

              CONTENT=$(echo $RESPONSE | jq -r '.output_text')

              echo "<!DOCTYPE html><html><head><title>$topic</title></head><body>" > $FILE
              echo "<h1>$topic</h1>" >> $FILE
              echo "$CONTENT" >> $FILE
              echo "</body></html>" >> $FILE

              COUNT=$((COUNT+1))
            fi
          done

      # ----------------------------------
      # REFRESH WEAK PAGES
      # ----------------------------------
      - name: Refresh Weak Pages
        if: steps.scoring.outputs.weak != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for file in ${{ steps.scoring.outputs.weak }}; do
            BROKER=$(echo $file | sed 's/-removal.html//')
            RESPONSE=$(curl -s https://api.openai.com/v1/responses \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"${MODEL}\",
                \"max_output_tokens\": ${MAX_TOKENS},
                \"input\": \"Rewrite and significantly improve the $BROKER removal guide with stronger authority tone and updated compliance language.\"
              }")

            CONTENT=$(echo $RESPONSE | jq -r '.output_text')
            echo "$CONTENT" > "$file"
          done

      # ----------------------------------
      # UPDATE SITEMAP
      # ----------------------------------
      - name: Update Sitemap
        run: |
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml
          for file in *.html compare/*.html states/*.html blog/*.html; do
            echo "<url><loc>https://www.hardlineprivacy.com/$file</loc></url>" >> sitemap.xml
          done
          echo "</urlset>" >> sitemap.xml

      # ----------------------------------
      # SINGLE STRATEGIC PR
      # ----------------------------------
      - name: Commit and PR
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="strategic-intel-$(date +%s)"
            git checkout -b $BRANCH
            git config --global user.name "Hardline Strategic Engine"
            git config --global user.email "strategy@hardlineprivacy.com"
            git add .
            git commit -m "Strategic intelligence expansion + refresh"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          fi

      - name: Open Pull Request
        if: env.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Strategic Intelligence Update",
              head: process.env.branch,
              base: "main",
              body: "Content scoring, gap expansion, and targeted refresh cycle."
            })
