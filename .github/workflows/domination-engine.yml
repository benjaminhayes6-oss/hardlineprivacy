name: Hardline Domination Engine

on:
  schedule:
    - cron: '0 16 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1800
  MAX_NEW_BROKERS: 5
  MAX_NEW_BLOGS: 2
  REFRESH_DAYS: 90

jobs:
  domination:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ----------------------------------
      # AUTHORITY SCORING MODEL
      # ----------------------------------
      - name: Calculate Authority Score
        run: |
          BROKER_COUNT=$(ls *-removal.html 2>/dev/null | wc -l)
          BLOG_COUNT=$(ls blog/*.html 2>/dev/null | wc -l)
          TOTAL_PAGES=$(ls *.html blog/*.html 2>/dev/null | wc -l)
          SCORE=$((BROKER_COUNT * 5 + BLOG_COUNT * 2 + TOTAL_PAGES))
          echo "Authority Score: $SCORE"
          echo "$SCORE" > authority-score.txt

      # ----------------------------------
      # DETECT AGING PAGES (90+ DAYS)
      # ----------------------------------
      - name: Detect Aging Pages
        id: aging
        run: |
          AGED=""
          for file in *-removal.html; do
            if [ -f "$file" ]; then
              LAST_MOD=$(git log -1 --format="%ct" -- "$file")
              NOW=$(date +%s)
              AGE=$(( (NOW - LAST_MOD) / 86400 ))
              if [ "$AGE" -gt "$REFRESH_DAYS" ]; then
                AGED="$AGED $file"
              fi
            fi
          done
          echo "aged=$AGED" >> $GITHUB_OUTPUT

      # ----------------------------------
      # INTERNAL LINK GRAPH INJECTION
      # ----------------------------------
      - name: Inject Internal Links
        run: |
          BROKER_PAGES=$(ls *-removal.html 2>/dev/null)
          for page in $BROKER_PAGES; do
            for target in $BROKER_PAGES; do
              if [ "$page" != "$target" ]; then
                grep -q "$target" "$page" || \
                echo "<p>See also: <a href=\"/$target\">Related removal guide</a></p>" >> "$page"
              fi
            done
          done

      # ----------------------------------
      # KEYWORD CLUSTER BLOG EXPANSION
      # ----------------------------------
      - name: Generate Cluster Blog Posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p blog
          TOPICS=("data broker laws explained" "how to remove public records online" "best privacy protection services comparison")
          COUNT=0
          for topic in "${TOPICS[@]}"; do
            if [ $COUNT -ge $MAX_NEW_BLOGS ]; then break; fi

            SLUG=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' )

            if [ ! -f "./blog/$SLUG.html" ]; then

              RESPONSE=$(curl -s https://api.openai.com/v1/responses \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "{
                  \"model\": \"${MODEL}\",
                  \"max_output_tokens\": ${MAX_TOKENS},
                  \"input\": \"Write a 1400+ word authoritative SEO article on: $topic. Include structured FAQ schema and internal link references to broker removal guides.\"
                }")

              CONTENT=$(echo $RESPONSE | jq -r '.output_text')

              FILE="blog/$SLUG.html"
              echo "<!DOCTYPE html><html><head><title>$topic | Hardline Privacy</title></head><body>" > $FILE
              echo "<h1>$topic</h1>" >> $FILE
              echo "$CONTENT" >> $FILE
              echo "</body></html>" >> $FILE

              COUNT=$((COUNT+1))
            fi
          done

      # ----------------------------------
      # REFRESH AGED BROKER PAGES
      # ----------------------------------
      - name: Refresh Aged Pages
        if: steps.aging.outputs.aged != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for file in ${{ steps.aging.outputs.aged }}; do
            BROKER=$(echo $file | sed 's/-removal.html//')
            RESPONSE=$(curl -s https://api.openai.com/v1/responses \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"${MODEL}\",
                \"max_output_tokens\": ${MAX_TOKENS},
                \"input\": \"Rewrite and improve the removal guide for $BROKER with updated compliance language and stronger SEO.\"
              }")

            CONTENT=$(echo $RESPONSE | jq -r '.output_text')
            echo "$CONTENT" > "$file"
          done

      # ----------------------------------
      # UPDATE SITEMAP
      # ----------------------------------
      - name: Update Sitemap
        run: |
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml
          for file in *.html blog/*.html; do
            echo "<url><loc>https://www.hardlineprivacy.com/$file</loc></url>" >> sitemap.xml
          done
          echo "</urlset>" >> sitemap.xml

      # ----------------------------------
      # CREATE SINGLE PR
      # ----------------------------------
      - name: Commit and PR
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="domination-$(date +%s)"
            git checkout -b $BRANCH
            git config --global user.name "Hardline Domination Engine"
            git config --global user.email "domination@hardlineprivacy.com"
            git add .
            git commit -m "Domination engine expansion + refresh"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          fi

      - name: Open Pull Request
        if: env.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Domination Engine Expansion",
              head: process.env.branch,
              base: "main",
              body: "Automated authority expansion, link graph reinforcement, refresh cycle, and cluster growth."
            })
