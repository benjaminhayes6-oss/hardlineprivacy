name: Hardline Intelligent Domination Engine

on:
  schedule:
    - cron: '0 17 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1600
  MAX_COMPARE_PER_WEEK: 1
  MAX_STATES_PER_WEEK: 1
  MAX_TOTAL_NEW_PAGES: 6

jobs:
  domination:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ----------------------------------
      # AUTHORITY SCORE v2
      # ----------------------------------
      - name: Calculate Authority Score
        run: |
          BROKERS=$(ls *-removal.html 2>/dev/null | wc -l)
          BLOGS=$(ls blog/*.html 2>/dev/null | wc -l)
          COMPARES=$(ls compare/*.html 2>/dev/null | wc -l)
          STATES=$(ls states/*.html 2>/dev/null | wc -l)
          SCORE=$((BROKERS*5 + BLOGS*2 + COMPARES*4 + STATES*3))
          echo "Authority Score: $SCORE"
          echo "$SCORE" > authority-score.txt

      # ----------------------------------
      # CREATE FOLDERS IF MISSING
      # ----------------------------------
      - name: Ensure Structure
        run: |
          mkdir -p compare
          mkdir -p states
          mkdir -p blog

      # ----------------------------------
      # GENERATE COMPARISON PAGE (1/WEEK)
      # ----------------------------------
      - name: Generate Comparison Page
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          TARGETS=("deleteme" "incogni" "onerep" "kanary" "brandyourself")
          COUNT=0

          for brand in "${TARGETS[@]}"; do
            if [ $COUNT -ge $MAX_COMPARE_PER_WEEK ]; then break; fi

            FILE="compare/${brand}-vs-hardline.html"

            if [ ! -f "$FILE" ]; then
              RESPONSE=$(curl -s https://api.openai.com/v1/responses \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "{
                  \"model\": \"${MODEL}\",
                  \"max_output_tokens\": ${MAX_TOKENS},
                  \"input\": \"Write a neutral, detailed, SEO-optimized comparison between ${brand} and Hardline Privacy. Include pricing comparison table, pros/cons, FAQ schema, and strong but professional positioning.\"
                }")

              CONTENT=$(echo $RESPONSE | jq -r '.output_text')

              echo "<!DOCTYPE html><html><head><title>${brand^} vs Hardline Privacy</title></head><body>" > $FILE
              echo "<h1>${brand^} vs Hardline Privacy</h1>" >> $FILE
              echo "$CONTENT" >> $FILE
              echo "</body></html>" >> $FILE

              COUNT=$((COUNT+1))
            fi
          done

      # ----------------------------------
      # GENERATE STATE PAGE (1/WEEK)
      # ----------------------------------
      - name: Generate State Page
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          STATES_LIST=("california" "texas" "florida" "new-york" "illinois")
          COUNT=0

          for state in "${STATES_LIST[@]}"; do
            if [ $COUNT -ge $MAX_STATES_PER_WEEK ]; then break; fi

            FILE="states/${state}-data-broker-removal.html"

            if [ ! -f "$FILE" ]; then
              RESPONSE=$(curl -s https://api.openai.com/v1/responses \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "{
                  \"model\": \"${MODEL}\",
                  \"max_output_tokens\": ${MAX_TOKENS},
                  \"input\": \"Write a detailed SEO authority page about data broker removal in ${state}. Include state privacy laws, compliance considerations, removal challenges, and FAQ schema.\"
                }")

              CONTENT=$(echo $RESPONSE | jq -r '.output_text')

              echo "<!DOCTYPE html><html><head><title>Data Broker Removal in ${state^}</title></head><body>" > $FILE
              echo "<h1>Data Broker Removal in ${state^}</h1>" >> $FILE
              echo "$CONTENT" >> $FILE
              echo "</body></html>" >> $FILE

              COUNT=$((COUNT+1))
            fi
          done

      # ----------------------------------
      # INTELLIGENT INTERNAL LINKING
      # ----------------------------------
      - name: Reinforce Internal Links
        run: |
          for file in compare/*.html states/*.html blog/*.html; do
            if [ -f "$file" ]; then
              grep -q "/pricing" "$file" || echo "<p><a href=\"/pricing\">View pricing</a></p>" >> "$file"
              grep -q "/trust" "$file" || echo "<p><a href=\"/trust\">Why trust Hardline</a></p>" >> "$file"
            fi
          done

      # ----------------------------------
      # UPDATE SITEMAP
      # ----------------------------------
      - name: Update Sitemap
        run: |
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml
          for file in *.html compare/*.html states/*.html blog/*.html; do
            echo "<url><loc>https://www.hardlineprivacy.com/$file</loc></url>" >> sitemap.xml
          done
          echo "</urlset>" >> sitemap.xml

      # ----------------------------------
      # LIMIT TOTAL NEW PAGES (GUARDRAIL)
      # ----------------------------------
      - name: Enforce Page Velocity Limit
        run: |
          NEW_COUNT=$(git status --porcelain | wc -l)
          if [ "$NEW_COUNT" -gt "$MAX_TOTAL_NEW_PAGES" ]; then
            echo "Too many new pages generated. Aborting."
            exit 1
          fi

      # ----------------------------------
      # SINGLE CONTROLLED PR
      # ----------------------------------
      - name: Commit and Create PR
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="domination-v10-$(date +%s)"
            git checkout -b $BRANCH
            git config --global user.name "Hardline Domination Engine"
            git config --global user.email "domination@hardlineprivacy.com"
            git add .
            git commit -m "Intelligent phased domination expansion"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          fi

      - name: Open Pull Request
        if: env.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Domination Phase Expansion",
              head: process.env.branch,
              base: "main",
              body: "Comparison page + state rollout + link reinforcement."
            })
