name: Hardline Strategic War Room

on:
  schedule:
    - cron: '0 20 * * 1'
  workflow_dispatch:

permissions:
  contents: read

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1200
  SITE_URL: https://www.hardlineprivacy.com/

jobs:
  war-room:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install google-api-python-client google-auth

      - name: Create GSC credential file
        run: |
          echo '${{ secrets.GSC_SERVICE_ACCOUNT_JSON }}' > gsc-key.json

      - name: Pull Search Console Data
        run: |
          python3 <<EOF
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from datetime import date, timedelta

          SCOPES = ['https://www.googleapis.com/auth/webmasters.readonly']
          SERVICE_ACCOUNT_FILE = 'gsc-key.json'

          credentials = service_account.Credentials.from_service_account_file(
              SERVICE_ACCOUNT_FILE, scopes=SCOPES)

          service = build('searchconsole', 'v1', credentials=credentials)

          end_date = date.today()
          start_date = end_date - timedelta(days=28)

          request = {
              'startDate': str(start_date),
              'endDate': str(end_date),
              'dimensions': ['query', 'page'],
              'rowLimit': 1000
          }

          response = service.searchanalytics().query(
              siteUrl='https://www.hardlineprivacy.com/',
              body=request).execute()

          with open('gsc-data.json', 'w') as f:
              json.dump(response, f)
          EOF

      - name: Analyze Market Signals
        run: |
          HIGH_IMPRESSIONS=$(jq '[.rows[] | select(.impressions > 50)] | length' gsc-data.json)
          echo "High impression rows: $HIGH_IMPRESSIONS"

      - name: Generate Strategic Forecast
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DATA=$(cat gsc-data.json)

          RESPONSE=$(curl -s https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"${MODEL}\",
              \"max_output_tokens\": ${MAX_TOKENS},
              \"input\": \"You are an executive SEO strategist. Analyze this Search Console data and produce a 90-day strategic action plan, ranking risk analysis, and expansion priorities: $DATA\"
            }")

          CONTENT=$(echo $RESPONSE | jq -r '.output_text')

          echo "# Strategic War Room Report" > war-room-report.md
          echo "$CONTENT" >> war-room-report.md

      - name: Upload War Room Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: war-room-dashboard
          path: |
            gsc-data.json
            war-room-report.md
