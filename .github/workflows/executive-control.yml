name: Hardline Executive Control Mode

on:
  schedule:
    - cron: '0 19 * * 1'
  workflow_dispatch:

permissions:
  contents: read

env:
  MODEL: gpt-4o-mini
  MAX_TOKENS: 1200

jobs:
  executive-control:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ----------------------------------
      # AUTHORITY METRICS
      # ----------------------------------
      - name: Calculate Authority Metrics
        id: metrics
        run: |
          BROKERS=$(ls *-removal.html 2>/dev/null | wc -l)
          BLOGS=$(ls blog/*.html 2>/dev/null | wc -l)
          COMPARES=$(ls compare/*.html 2>/dev/null | wc -l)
          STATES=$(ls states/*.html 2>/dev/null | wc -l)

          TOTAL=$((BROKERS + BLOGS + COMPARES + STATES))

          LINKS=$(grep -roh "<a href=" . | wc -l)

          echo "{
            \"broker_pages\": $BROKERS,
            \"blog_pages\": $BLOGS,
            \"comparison_pages\": $COMPARES,
            \"state_pages\": $STATES,
            \"total_pages\": $TOTAL,
            \"total_links\": $LINKS
          }" > authority-dashboard.json

      # ----------------------------------
      # CONVERSION SCORING
      # ----------------------------------
      - name: Score Conversion Presence
        run: |
          PRICING_LINKS=$(grep -roh "/pricing" . | wc -l)
          TRUST_LINKS=$(grep -roh "/trust" . | wc -l)

          echo "Pricing Links: $PRICING_LINKS" > conversion-score.txt
          echo "Trust Links: $TRUST_LINKS" >> conversion-score.txt

      # ----------------------------------
      # CONTENT VELOCITY
      # ----------------------------------
      - name: Measure Growth Velocity
        run: |
          THIRTY_DAYS_AGO=$(date -d "30 days ago" +%s)
          RECENT=$(git log --since="30 days ago" --name-only --pretty=format: | grep ".html" | sort -u | wc -l)
          echo "Pages added/modified in last 30 days: $RECENT" > velocity.txt

      # ----------------------------------
      # EXECUTIVE STRATEGY BRIEF
      # ----------------------------------
      - name: Generate Executive Brief
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          METRICS=$(cat authority-dashboard.json)

          RESPONSE=$(curl -s https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"${MODEL}\",
              \"max_output_tokens\": ${MAX_TOKENS},
              \"input\": \"You are a strategic SEO advisor. Based on these metrics: $METRICS, generate a quarterly growth strategy brief including risks, priorities, and expansion opportunities.\"
            }")

          CONTENT=$(echo $RESPONSE | jq -r '.output_text')
          echo "# Executive Strategic Brief" > executive-brief.md
          echo "$CONTENT" >> executive-brief.md

      # ----------------------------------
      # UPLOAD EXECUTIVE ARTIFACTS
      # ----------------------------------
      - name: Upload Executive Report
        uses: actions/upload-artifact@v4
        with:
          name: executive-dashboard
          path: |
            authority-dashboard.json
            conversion-score.txt
            velocity.txt
            executive-brief.md
